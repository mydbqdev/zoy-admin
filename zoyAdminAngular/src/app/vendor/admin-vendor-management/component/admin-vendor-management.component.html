
<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="medium" color="#fff" type="custom" [fullScreen]="true">
    <div class="spinner-container"><img class="spinner-home-logo" src="assets/images/home-logo.png" alt="Home"/>
      <img class="spinner-location-logo" src="assets/images/location-logo.png" alt="User"/>
      <div class="spinner-loading">Loading</div>
    </div>
</ngx-spinner>
  <!-- Content Wrapper. Contains page content -->
  <div id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <app-sidebar></app-sidebar>
      <!-- End of Sidebar -->
  
      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column" [ngClass]=" isExpandSideBar ?'side-bar-expand':'side-bar-collaspe'">
          <!-- Main Content -->
          <div id="content">
                  <div style="display: block;margin-bottom: 5.375rem;">
                  <!-- Topbar -->
                  <app-header></app-header>
                  <!-- End of Topbar -->
                  </div>

              <!-- Begin Page Content -->
              <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-3">
                    <h3 class="h3 mb-0"><span class="text-header-800 text-header-border">Vendor </span><span class="text-header-800-blue">Management</span></h3> 
                </div>
                  
                  <!-- Content Row -->
                  <div>
                        <div class="card shadow mb-3">
                            <!-- Card Body -->
                           <!-- src/app/admin/admin-vendor-management/admin-vendor-management.component.html -->
                        <div style="margin: 10px;">

                          <!-- Vendor List View -->
                          <div >
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h4>Vendor List</h4>
                              <div class="btn-group" role="group" aria-label="Vendor status filter">
                                <button type="button" class="btn"
                                        [class.btn-primary]="currentFilter === 'All'"
                                        [class.btn-outline-primary]="currentFilter !== 'All'"
                                        (click)="setFilter('All')">All</button>
                                <button type="button" class="btn"
                                        [class.btn-primary]="currentFilter === VendorStatus.PendingApproval"
                                        [class.btn-outline-primary]="currentFilter !== VendorStatus.PendingApproval"
                                        (click)="setFilter(VendorStatus.PendingApproval)">Pending for approval</button>
                                <button type="button" class="btn"
                                        [class.btn-primary]="currentFilter === VendorStatus.Approved || currentFilter === VendorStatus.Active"
                                        [class.btn-outline-primary]="currentFilter !== VendorStatus.Approved && currentFilter !== VendorStatus.Active"
                                        (click)="setFilter(VendorStatus.Approved)">Approved</button>
                                <button type="button" class="btn"
                                        [class.btn-primary]="currentFilter === VendorStatus.Rejected"
                                        [class.btn-outline-primary]="currentFilter !== VendorStatus.Rejected"
                                        (click)="setFilter(VendorStatus.Rejected)">Rejected</button>
                                <button type="button" class="btn"
                                        [class.btn-primary]="currentFilter === VendorStatus.Inactive"
                                        [class.btn-outline-primary]="currentFilter !== VendorStatus.Inactive"
                                        (click)="setFilter(VendorStatus.Inactive)">Inactive</button>
                              </div>
                            </div>

                        <div class="card shadow mb-3">
                        <div class="card-body" style="display: block;margin: 0px;padding: 2px;" >
                          <div class="scrollable-container-main">
                          <div>
                            <table mat-table [dataSource]="dataSource" matSort 
                              (matSortChange)="announceSortChange($event)" matSortActive="companyName" matSortDirection="asc">

                          <!-- Company Name -->
                          <ng-container matColumnDef="companyName">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 600; width: 180px;" title="Company Name">
                              COMPANY NAME
                              <span style="margin-left: 2px;">
                                <i class="fas fa-lg fa-sort-up sorting-normal-color" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['companyName'] === 'asc'}"></i>
                                <i class="fas fa-lg fa-sort-down sorting-normal-color" 
                                  style="margin-left:-11px" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['companyName'] === 'desc'}"></i>
                              </span>
                            </th>
                            <td mat-cell *matCellDef="let element" style="width: 180px;">
                              {{ element.vendor_company_name }}
                            </td>
                          </ng-container>

                          <!-- Contact Person -->
                          <ng-container matColumnDef="contactPerson">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 600; width: 180px;" title="Contact Person">
                              CONTACT PERSON
                              <span style="margin-left: 2px;">
                                <i class="fas fa-lg fa-sort-up sorting-normal-color" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['contactPerson'] === 'asc'}"></i>
                                <i class="fas fa-lg fa-sort-down sorting-normal-color" 
                                  style="margin-left:-11px" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['contactPerson'] === 'desc'}"></i>
                              </span>
                            </th>
                            <td mat-cell *matCellDef="let element" style="width: 180px;">
                              {{ element.vendor_first_name }} {{ element.vendor_last_name }}
                            </td>
                          </ng-container>

                          <!-- Email -->
                          <ng-container matColumnDef="email">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 600; width: 240px;" title="Email ID">
                              EMAIL ID
                              <span style="margin-left: 2px;">
                                <i class="fas fa-lg fa-sort-up sorting-normal-color" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['email'] === 'asc'}"></i>
                                <i class="fas fa-lg fa-sort-down sorting-normal-color" 
                                  style="margin-left:-11px" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['email'] === 'desc'}"></i>
                              </span>
                            </th>
                            <td mat-cell *matCellDef="let element" style="width: 240px;">
                              {{ element.vendor_email }}
                            </td>
                          </ng-container>

                          <!-- Contact Number -->
                          <ng-container matColumnDef="contactNumber">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 600; width: 160px;" title="Contact Number">
                              CONTACT NUMBER
                              <span style="margin-left: 2px;">
                                <i class="fas fa-lg fa-sort-up sorting-normal-color" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['contactNumber'] === 'asc'}"></i>
                                <i class="fas fa-lg fa-sort-down sorting-normal-color" 
                                  style="margin-left:-11px" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['contactNumber'] === 'desc'}"></i>
                              </span>
                            </th>
                            <td mat-cell *matCellDef="let element" style="width: 160px;">
                              {{ element.vendor_mobile_no }}
                            </td>
                          </ng-container>

                          <!-- Status -->
                          <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 600; width: 140px;" title="Status">
                              STATUS
                              <span style="margin-left: 2px;">
                                <i class="fas fa-lg fa-sort-up sorting-normal-color" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['status'] === 'asc'}"></i>
                                <i class="fas fa-lg fa-sort-down sorting-normal-color" 
                                  style="margin-left:-11px" 
                                  [ngClass]="{'sorting-selected-color': columnSortDirections['status'] === 'desc'}"></i>
                              </span>
                            </th>
                            <td mat-cell *matCellDef="let element" style="width: 140px;">
                              <span class="common-status"
                                    [ngClass]="{
                                      'status-active': element.vendor_status === 'Approved',
                                      'status-pending': element.vendor_status === 'Pending for approval',
                                      'status-inactive': element.vendor_status === 'Inactive'
                                    }">
                                {{ element.vendor_status }}
                              </span>
                            </td>
                          </ng-container>
                          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky:true"></tr>
                          <tr mat-row *matRowDef="let row; columns: displayedColumns;" data-bs-toggle="offcanvas" data-bs-target="#vendorsDetailsModel" aria-controls="offcanvasUpdateLabel" (click)="viewVendorDetails(row)"></tr>
                                                          
                        </table>
                        <div style="text-align: center;min-height: 45px;padding-top: 10px;" *ngIf="dataSource.data.length==0"> No records found</div>                 
                        </div>
                          </div>
                          <mat-paginator #paginator [length]="totalProduct" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" showFirstLastButtons (page)="pageChanged($event)"></mat-paginator>
                        </div>
                        </div>
                          </div>

                        </div>
                        </div>             
                  </div>
              </div>
              <!-- /.container-fluid -->
          </div>
          <!-- End of Main Content -->
      </div>
      <!-- End of Content Wrapper -->
  </div>
  <!-- End of Page Wrapper -->
  </div>



  <div class="offcanvas offcanvas-end" tabindex="-1" id="vendorsDetailsModel" aria-labelledby="offcanvasRightLabel" data-bs-backdrop="static">
    <div class="offcanvas-header bg-gradiant-popup-header">
        <h5 class="offcanvas-title" id="offcanvasRightLabel"> Vendor Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" #detailsCloseModal></button>
    </div>
    <hr class="sidebar-divider my-0">
    <div class="offcanvas-body">
      <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6"><strong>Company Name:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_company_name }}</div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Contact Person:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_first_name }} {{ selectedVendor.vendor_last_name }}</div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Email ID:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_email }}</div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Address:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_address }}</div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Contact Number:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_mobile_no }}</div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Alternative Number:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_alternative_no || 'N/A' }}</div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Services Offered:</strong></div>
      <div class="col-md-6">
        {{ services() }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>GST/Registration Number:</strong></div>
      <div class="col-md-6">{{ selectedVendor.vendor_gst_registrastion_no || 'N/A' }}</div>
    </div>
    <div class="row mb-3" *ngIf="selectedVendor.vendor_file_paths?.length">
      <div class="col-md-6"><strong>Attachments:</strong></div>
      <div class="col-md-6">
        <ng-container *ngFor="let file of selectedVendor.vendor_file_paths; let i = index">
          <a [href]="file" target="_blank" class="btn btn-sm btn-outline-primary me-2 mb-1">
            View Attachment {{ i + 1 }}
          </a>
        </ng-container>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6"><strong>Current Status:</strong></div>
      <div class="col-md-6">
       <span class="common-status"
            [ngClass]="{
              'status-active': selectedVendor.vendor_status === 'Approved',
              'status-pending': selectedVendor.vendor_status === 'Pending for approval',
              'status-inactive': selectedVendor.vendor_status === 'Inactive'
            }">
        {{ selectedVendor.vendor_status }}
      </span>
      </div>
    </div>
    <div class="row mb-3">
    <div class="col-md-6"><strong>Designation:</strong></div>
    <div class="col-md-6">
      {{ venderDesignation || 'N/A' }} 
    </div>
  </div>
  <div class="row mb-3 ml-1">
    <div>
    <select id="venderDesignation" class="form-select" [(ngModel)]="venderDesignation" 
       [ngClass]="{ 'is-invalid': isApproving && !venderDesignation}">
        <option value="" disabled selected>Select Designation</option>
        <option *ngFor="let designation of designationList" [value]="designation.id">
          {{ designation.name }}
        </option>
      </select>
      </div>
       <div *ngIf="isApproving && !venderDesignation" class="text-danger">
         Designation is required.
        </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6"><strong>Vender Group:</strong></div>
    <div class="col-md-6">
     <span> {{ venderGroupName || 'N/A' }}</span>
    </div>
  </div>
  <div class="row mb-3">
    <div class="input-group"> 
    <span class="input-group-text" id="salesPrefix">vender-</span>
        <input  type="text" id="venderGroupName" name="venderGroupName" class="form-control"
               [(ngModel)]="venderGroupName"  placeholder="e.g., City-cluster-Zone"
                [ngClass]="{ 'is-invalid': isApproving && (!venderGroupName || isValidGroupName(venderGroupName) )}">
       
        </div>
        <div>
        <div *ngIf="isApproving && !venderGroupName" class="text-danger">
             Group is required.
        </div>
        <div *ngIf="isApproving && (venderGroupName &&  isValidGroupName(venderGroupName))" class="text-danger">
            Group should be formed from 'City-Cluster-Zone'.
        </div>
        </div>
  </div>

     <!-- Display reasons if applicable -->
      <div *ngIf="selectedVendor.vendor_status === VendorStatus.Rejected && selectedVendor.rejectionReason" class="row mb-3">
        <div class="col-md-6"><strong>Rejection Reason:</strong></div>
        <div class="col-md-6 text-danger">{{ selectedVendor.rejectionReason }}</div>
      </div>
      <div *ngIf="selectedVendor.vendor_status === VendorStatus.Inactive && selectedVendor.inactiveReason" class="row mb-3">
        <div class="col-md-6"><strong>Inactive Reason:</strong></div>
        <div class="col-md-6 text-warning">{{ selectedVendor.inactiveReason }}</div>
      </div>

      <!-- Action Buttons and Forms based on Current Vendor Status -->
      <div class="d-flex flex-wrap gap-2 mt-4">
        <!-- Actions for Pending for approval vendors -->
        <div *ngIf="selectedVendor.vendor_status === VendorStatus.PendingApproval">
          <button class="btn btn-success me-2" (click)="approveVendorDetails()">
            Approve Vendor
          </button>
          <!-- Toggle button for rejection reason form -->
          <button class="btn btn-danger" type="button" data-bs-toggle="collapse" data-bs-target="#rejectFormCollapse" aria-expanded="false" aria-controls="rejectFormCollapse" 
          (click)="scrollTo('rejectionForm')">
            Reject Vendor
          </button>
        </div>

        <!-- Rejection Reason Form (Collapsible) -->
        <div class="collapse w-100 mt-2" id="rejectFormCollapse"  #rejectionForm>
          <div class="card card-body bg-light">
          <div class="mb-3">
            <label for="rejectionReason" class="form-label">
              Reason for Rejection <span class="text-danger">*</span>
            </label>
            <textarea
              id="rejectionReason"
              [(ngModel)]="rejectionReason"
              name="rejectionReason"
              class="form-control" rows="3"
               [ngClass]="{ 'is-invalid':isRejecting && !rejectionReason }"
            ></textarea>
            <div *ngIf="isRejecting && !rejectionReason" class="text-danger">
              Rejection reason is required.
            </div>
          </div>
          <button
            type="button"
            class="btn btn-danger btn-sm"
            (click)="rejectingVendorDetails()"
          >
            Confirm Reject
          </button>


          </div>
        </div>

        <!-- Actions for Approved, Active, or Inactive vendors (to change status) -->
        <div *ngIf="selectedVendor.vendor_status === VendorStatus.Approved || selectedVendor.vendor_status === VendorStatus.Active || selectedVendor.vendor_status === VendorStatus.Inactive">
          <!-- Toggle button for status change form -->
          <button class="btn btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#statusChangeFormCollapse" aria-expanded="false" aria-controls="statusChangeFormCollapse"
          (click)="scrollTo('statusFormDiv')">
            Change Status
          </button>
        </div>

        <!-- Status Change Form (Collapsible) -->
        <div class="collapse w-100 mt-2" id="statusChangeFormCollapse" #statusFormDiv>
          <div class="card card-body bg-light">
            <form [formGroup]="statusChangeForm" (ngSubmit)="changeVendorStatus()">
              <div class="mb-3">
                <label for="newStatus" class="form-label">New Status <span class="text-danger">*</span></label>
                <select id="newStatus" formControlName="newStatus" class="form-select"
                        (change)="onStatusChangeSelection()"
                        [class.is-invalid]="statusChangeForm.get('newStatus')?.invalid && statusChangeForm.get('newStatus')?.touched">
                  <option value="" disabled>Select a new status</option>
                  <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
                </select>
                <div *ngIf="statusChangeForm.get('newStatus')?.invalid && statusChangeForm.get('newStatus')?.touched" class="invalid-feedback">
                  New status is required.
                </div>
              </div>
              <!-- Reason field, conditionally displayed/required -->
              <div class="mb-3" *ngIf="statusChangeForm.get('newStatus')?.value === VendorStatus.Inactive || statusChangeForm.get('newStatus')?.value === VendorStatus.Rejected">
                <label for="statusChangeReason" class="form-label">Reason <span class="text-danger">*</span></label>
                <textarea id="statusChangeReason" formControlName="reason" class="form-control" rows="2"
                          [class.is-invalid]="statusChangeForm.get('reason')?.invalid && statusChangeForm.get('reason')?.touched"></textarea>
                <div *ngIf="statusChangeForm.get('reason')?.invalid && statusChangeForm.get('reason')?.touched" class="invalid-feedback">
                  Reason is required for this status change.
                </div>
              </div>
              <button type="submit" class="btn btn-primary btn-sm" [disabled]="statusChangeForm.invalid || isChangingStatus">
                <span *ngIf="isChangingStatus" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                {{ isChangingStatus ? 'Updating...' : 'Update Status' }}
              </button>
            </form>
          </div>
        </div>
      </div>
  </div>
    </div>
</div>

