<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="medium" color="#fff" type="ball-circus" [fullScreen]="true">
  <p style="color: white;">Loading ...</p>
</ngx-spinner>
<div id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <app-sidebar></app-sidebar>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column" [ngClass]=" isExpandSideBar ?'side-bar-expand':'side-bar-collaspe'">
          <!-- Main Content -->
          <div id="content">
                <div style="display: block;margin-bottom: 5.375rem;">
                <!-- Topbar -->
                <app-header></app-header>
                <!-- End of Topbar -->
                </div>

              <!-- Begin Page Content -->
              <div class="container-fluid" style="margin-top: -5px;">
                <div class="d-flex mb-3">
                    <h3 class="h3 mb-0"><span class="text-header-800 text-header-border">Reports</span></h3> 
                 </div>  
                <div class="row">
                 <div class="col-sm-10">
                  <div style="padding:10px 10px 5px;border:1px solid#dbdbdb;border-radius: 15px; font-size: 13px;">
                    <div class="d-flex mb-2">
                    <div style="width: 110px;">
                      <label for="email">City / Location</label>
                        <select class="form-select form-select-sm" aria-label="Default select example"   [(ngModel)]="cityLocationName" style=" font-size: 12px;">
                            <option *ngFor="let city of cityLocation"  [value]="city" >{{city}}</option>
                        </select>
                    </div> 
                    <div class="ml-2" style="width: 200px;">
                        <label for="email">Report Type</label>
                        <select class="form-select form-select-sm" aria-label="Default select example" [(ngModel)]="reportName" (ngModelChange)="changeReport()" style=" font-size: 12px;" > 
                            <option *ngFor="let report of reportNamesList"  [value]="report.name" >{{report.name}}</option>
                        </select>
                    </div>
                    <div class="ml-2" style="width: 340px;">
                           <label for="category">Date Range</label>
                            <div class="d-flex gap-2">
                              <input type="datetime-local" class="form-control form-control-sm" style="width: 160px;font-size: 12px; " id="fromDate" [(ngModel)]="fromDate" 
                                    [ngClass]="{'is-invalid': (!fromDate ||(fromDate>toDate && toDate))}" 
                                    [title]="!fromDate? 'From Date is required':((fromDate>toDate && toDate)?'Invalid date range':'') " /> - 
                              <input type="datetime-local" class="form-control form-control-sm" style="width: 160px; font-size: 12px;" id="toDate"  [(ngModel)]="toDate" 
                                    [ngClass]="{'is-invalid': (!toDate ||(fromDate>toDate && fromDate ))}" 
                                    [title]="!toDate? 'To Date is required':((fromDate>toDate && fromDate)?'Invalid date range':'') "/>
                            </div>
                    </div>
                    <div class="ml-2" style="padding-top:26px;" *ngIf="reportName!='Vendor Payments Gst Report'">
                      <a class="btn btn-dark btn-sm" title="Advance Search" id="advanceSearch"
                      data-toggle="dropdown"><i class="fas fa-angle-double-down"></i></a>
                      <div id="dropdownMenu" class="dropdown-menu custom-dropdown-width p-2 shadow" style="width: 500px;margin-right: 150px;" aria-labelledby="advanceSearch" data-bs-auto-close="false">
                        <div>
                          <div class="row mt-2 mb-0">

                            <div class="col-sm-6" *ngIf="reportName =='Ratings and Reviews Report'">
                              <div class="form-group">
                                <label for="overallRating" class="text-search-header">Overall Rating</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.overallRating" name="overallRating" />
                              </div>
                            </div>
                           
                            <div class="col-sm-6" *ngIf=" reportName =='Tenant Transactions Report' || reportName == 'Tenant Dues Report' || reportName =='Tenant Payments GST Report' || reportName =='Tenant Refunds Report' || reportName =='Ratings and Reviews Report'">
                              <div class="form-group">
                                <label for="tenantName" class="text-search-header">Tenant Name</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.tenantName" name="tenantName" />
                              </div>
                            </div>
                            <div class="col-sm-6" *ngIf=" reportName =='Tenant Transactions Report' || reportName == 'Tenant Dues Report' || reportName =='Tenant Payments GST Report' || reportName =='Tenant Refunds Report'">
                              <div class="form-group">
                                <label for="tenantContactNum" class="text-search-header">Tenant contact</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.tenantContactNum" name="tenantContactNum" />
                              </div>
                            </div>
                            <div class="col-sm-6" *ngIf="reportName =='Tenant Refunds Report'">
                              <div class="form-group">
                                <label for="refundTitle" class="text-search-header">Refund Title</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.refundTitle" name="refundTitle" />
                              </div>
                            </div>
                           
                            
                            <div class="col-sm-6" *ngIf="reportName == 'Owner Payments Dues Report' || reportName == 'Owner Payments Gst Report' || reportName == 'Owner Payments Report'" >
                              <div class="form-group">
                                <label for="ownerName" class="text-search-header">Owner Name</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.ownerName" name="ownerName" />
                              </div>
                            </div>
                          
                            <div class="col-sm-6" *ngIf="reportName == 'Owner Payments Dues Report' || reportName == 'Owner Payments Gst Report' || reportName == 'Owner Payments Report' " >
                              <div class="form-group">
                                <label for="ownerEmail" class="text-search-header">Owner Email</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.ownerEmail" name="ownerEmail" />
                              </div>
                            </div>
                          
                            <div class="col-sm-6" *ngIf="reportName == 'Owner Payments Dues Report' || reportName == 'Owner Payments Gst Report' ||  reportName =='Tenant Transactions Report' 
                                                       || reportName == 'Owner Payments Report' || reportName =='Tenant Payments GST Report' || reportName == 'Tenant Dues Report' || reportName =='Ratings and Reviews Report'">
                              <div class="form-group">
                                <label for="pgName" class="text-search-header">PG PROPERTY NAME</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.pgName" name="pgName" />
                              </div>
                            </div>
                          
                            <div class="col-sm-6" *ngIf="reportName == 'Consolidated Finance Report'">
                              <div class="form-group">
                                <label for="payerType" class="text-search-header">Payee/Payer type</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.payerType" name="payerType" />
                              </div>
                            </div> 
                          
                            <div class="col-sm-6" *ngIf="reportName == 'Consolidated Finance Report'" >
                              <div class="form-group">
                                <label for="payerName" class="text-search-header">Payee/Payer Name</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.payerName" name="payerName" />
                              </div>
                            </div>

                            <div class="col-sm-6" *ngIf="reportName == 'Consolidated Finance Report' || reportName == 'Owner Payments Gst Report' || reportName =='Tenant Transactions Report' 
                                                      || reportName =='Tenant Payments GST Report'|| reportName == 'Tenant Dues Report'">
                              <div class="form-group">
                                <label for="transactionNumber" class="text-search-header">Transaction Number </label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.transactionNumber" name="transactionNumber" />
                              </div>
                            </div>
                            
                            <div class="col-sm-6" *ngIf="reportName =='Tenant Transactions Report' || reportName == 'Owner Payments Report' || reportName =='Tenant Refunds Report'">
                              <div class="form-group">
                                <label for="transactionStatus" class="text-search-header">Transaction Status</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.transactionStatus" name="transactionStatus" />
                              </div>
                            </div>

                            <div class="col-sm-6" *ngIf="reportName == 'Owner Payments Report'">
                              <div class="form-group">
                                <label for="ownerApprovalStatus" class="text-search-header">Owner Approval</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.ownerApprovalStatus" name="ownerApprovalStatus" />
                              </div>
                            </div>

                            <div class="col-sm-6" *ngIf="reportName =='Tenant Refunds Report'">
                              <div class="form-group">
                                <label for="bookingId" class="text-search-header">Booking Id</label>
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="filterData.bookingId" name="bookingId" />
                              </div>
                            </div>

                          

                          </div>
                        </div>
                       
                        <!-- Apply Now button -->
                        <div class="d-flex justify-content-center align-items-center mt-2">
                          <button type="button" class="btn btn-primary-custom btn-sm" (click)="generateReport()"  >Search / Generate Report</button>
                        </div>
                     </div>
                    </div>
                    <div class="ml-2">
                      <div style="padding-top:27px;">
                        <button type="button" class="btn btn-primary-custom btn-sm" (click)="generateReport()" style=" font-size: 12px;" >Show Report</button>
                      </div>
                    </div>
                  </div>
                  
                  </div>
                </div>
                  <div class="col-sm-2">
                  <div class="ml-3" style="padding-top:37px;;width: 115px;"> 
                  
                  
                    <div class="dropdown no-arrow">
                      <button class="btn btn-primary-custom btn-sm"  role="button" id="dropdownMenuDownload" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" [disabled]="downloadProgress">
                        <i class="fas fa-download mr-2" *ngIf="!downloadProgress"></i>
                        <img src="assets/images/loading.gif" class="mr-1" *ngIf="downloadProgress">
                        <span style="font-size: 12px;" >Download<span *ngIf="downloadProgress">ing</span> </span>
                      </button>                           
                      <div class="dropdown-menu dropdown-menu-right shadow animated-fade-in" aria-labelledby="dropdownMenuDownload" style="min-width:1rem !important;">
                        <a class="dropdown-item" href="javascript:void(0)" (click)="downloadPdf('pdf')">As Pdf </a><hr style="margin-top: 0rem !important; margin-bottom: 0rem !important;">
                        <a class="dropdown-item" href="javascript:void(0)" (click)="downloadPdf('excel')"> As Excel</a><hr style="margin-top: 0rem !important; margin-bottom: 0rem !important;">
                        <a class="dropdown-item" href="javascript:void(0)" (click)="downloadPdf('csv')">As CSV</a>   
                      </div>
                   </div>
                  </div>
                </div>
                </div>
                  <div class="row mt-2">
                      <div class="col-xl-12 col-lg-12">
                          <div class="card shadow mb-3">
                              <!-- Card Body -->
                              <div class="card-body" style="padding: 2px;margin: 0px;" >
                                <div>
                                <div class="scrollable-container-main">    
                                  <table mat-table [dataSource]="reportDataSource" matSort
                                           (matSortChange)="onSortData($event)" matSortActive="name" matSortDirection="asc" 
                                           matSortDisableClear multiTemplateDataRows>
                                    <ng-container *ngFor="let column of selectedReportColumns">
                                      <ng-container [matColumnDef]="column" *ngIf=" column != 'reviews'">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 400;" [matTooltip]="columnHeaders[column] "> 
                                          {{ columnHeaders[column] || column }}
                                          <i class="fas fa-lg fa-sort ml-1" style="color:#d1cfcf;margin-right: 3px;"></i>
                                          <i class="fas fa-lg fa-sort-up" *ngIf="sortActive === column && sortDirection === 'asc'" 
                                             style="margin-right: 3px;margin-left: -14px;"></i>
                                          <i class="fas fa-lg  fa-sort-down" *ngIf="sortActive === column && sortDirection === 'desc'" 
                                             style="margin-right: 3px;margin-left: -14px;"></i></th>
                                        <td mat-cell *matCellDef="let element" >  {{  element[column] == undefined || element[column] == '' ? '-' : element[column] }} </td>
                                      </ng-container>

                                      <ng-container [matColumnDef]="column" *ngIf="column == 'reviews' " >
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="font-weight: 400;"> 
                                          REVIEWS</th>
                                        <td mat-cell *matCellDef="let element" > 
                                          <span style="cursor: pointer;"  data-toggle="modal" data-target="#reviewsModel" (click)="viweReviewsReplyDetails(element)">
                                            <i class="bi bi-eye" aria-hidden="true" data-toggle="tooltip" data-placement="left" title="View Details"  ></i>
                                        </span>
                                        </td>
                                      </ng-container>
                                    </ng-container>

                                       <!-- <ng-container matColumnDef="actions">
                                      <th mat-header-cell *matHeaderCellDef mat-sort-header sortActionDescription="Sort by actions"></th>
                                      <td mat-cell *matCellDef="let element">
                                      <span style="cursor: pointer;" data-bs-toggle="offcanvas" data-bs-target="#viewDetails"  (click)="viewReport(element)">
                                          <i class="bi bi-eye" aria-hidden="true" data-toggle="tooltip" data-placement="left" title="View Details"  ></i>
                                      </span>
                                    
                                      </td>
                                  </ng-container>  -->

                                 <!--   <ng-container matColumnDef="actions">
                                      <th mat-header-cell style="" *matHeaderCellDef mat-sort-header sortActionDescription="Sort by actions"></th>
                                      <td mat-cell style="" *matCellDef="let element">
                                      <span style="cursor: pointer;" data-bs-toggle="offcanvas" data-bs-target="#viewDetails"  (click)="viewReport(element)">
                                          <i class="bi bi-eye" aria-hidden="true" data-toggle="tooltip" data-placement="left" title="View Details"  ></i>
                                      </span>
                                     <span style="cursor: pointer; margin-left: 10px;" (click)="onExport(element)">
                                          <i class="bi bi-upload" aria-hidden="true" data-toggle="tooltip" data-placement="left" title="Export"></i>
                                      </span
                                      </td>
                                  </ng-container>  -->
                                  
                                    <tr mat-header-row *matHeaderRowDef="selectedReportColumns; sticky:true"></tr>
                                    <tr mat-row *matRowDef="let row; columns: selectedReportColumns;"></tr>
                                  </table>
                                  <div style="text-align: center; min-height: 45px; padding-top: 10px;" 
                                  *ngIf="reportDataSource.data.length === 0">
                                    No records found
                                  </div>
                                   </div> 
                                   <mat-paginator #paginator [length]="totalProduct" [pageSize]="pageSize" 
                                   [pageSizeOptions]="pageSizeOptions" showFirstLastButtons 
                                   (page)="pageChanged($event)">
                                  </mat-paginator>
                                  </div> 
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              <!-- /.container-fluid -->

          </div>
          <!-- End of Main Content -->

      </div>
      <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->
</div>

 <!-- viewDetails
<div class="offcanvas offcanvas-end" tabindex="-1" id="viewDetails" aria-labelledby="offcanvasRightLabel" data-bs-backdrop="static">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasRightLabel">{{reportName}} Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <hr class="sidebar-divider my-0">
    <div class="offcanvas-body">
     <div style="font-size: 13px;">   

    <div *ngFor="let key of objectKeys(reportData)">
      <div class="row mb-1">
          <div class="col-sm-5 font-weight-bold">
              {{ columnHeaders[key] || key }}
          </div>
          <div class="col-sm-7">: {{ reportData[key] }}</div>
      </div>
    </div>
    </div>
    </div>
</div>
-->


<div class="modal fade" id="reviewsModel" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog model-center" role="document">  
    <div class="modal-content">
     <div class="modal-header" style="color: #fff;background-color: #925FE2;border-color: #955cf1;"> 
        <h5 class="modal-title ">Review Summary</h5>
        <button type="button"  class="btn-close" data-dismiss="modal" aria-label="Close"  style="background-color: #fff;" #reviewsModelClose >
        </button>
      </div>
      <div class="modal-body">
        
        <div class="pl-3 pr-3">
          <div class="row">
            <div class="col-sm-4" style="font-size: 14px;">PG PROPERTY NAME</div>
            <div class="col-sm-1 align-items-center">:</div>
            <div class="col-sm-6" style="font-size: 14px;color: gray;">{{reviewsReplyDetails.pgName}}</div>
            <div class="col-sm-1">
              <div class="rating-container">
                <div class="rating-box" [ngClass]="{'low-rating': +reviewsReplyDetails.overallRating < 3}">
                  <span class="star">&#9733;</span> 
                  <span class="rating-number"> {{reviewsReplyDetails.overallRating}}</span> 
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-4" style="font-size: 14px;">Tenant Name</div>
            <div class="col-sm-1 align-items-center">:</div>
            <div class="col-sm-7" style="font-size: 14px;color: gray;">{{reviewsReplyDetails.customerName}}</div>
          </div>
          <div class="row">
            <div class="col-sm-4" style="font-size: 14px;">Tenant Mobile no.</div>
            <div class="col-sm-1 align-items-center">:</div>
            <div class="col-sm-7" style="font-size: 14px;color: gray;">{{reviewsReplyDetails.customerMobileNo}}</div>
          </div>
        
      </div>
        <div class="card card-body ml-2 mr-2 mb-2 p-2 " style="max-height: 400px; overflow-y: auto;">
          <div class="mt-2 ml-2">
            <div class="d-flex">
            <div>
                <div class="profile-top" *ngIf="!reviewsReplyDetails.customerImage" > 
                    {{reviewsReplyDetails.customerName?.charAt(0).toUpperCase()}} 
                </div>
                <img [src]="reviewsReplyDetails.customerImage" *ngIf="reviewsReplyDetails.customerImage" class="profile-top" alt="User Image">                        
            </div>
            <div>
            <div style="padding-top:5px">    
            <span class="ml-2 d-none d-lg-inline text-gray-600 small text-truncate" style="max-width: 100px;">
                {{reviewsReplyDetails.customerName}} 
            </span>
            </div>
            <div class="ml-2" style="font-size: 11px;color:#bdb9b9;"> {{reviewsReplyDetails.reviewDate  | date: 'MMM d, y' }}</div>
          </div>
           </div>
          <div> {{reviewsReplyDetails.writtenReview}} </div>
        </div>
        <div >
          <div class="mt-2"  *ngFor="let review of reviewsReplyDetails.reviews" >
              <div *ngIf="review.customerId">
                <div class="d-flex">
                <div>
                    <img [src]="review.customerImage" *ngIf="review.customerImage" class="profile-top" alt="User Image">                        
                </div>
                <div>
                    <div> 
                      <span class="ml-2 d-none d-lg-inline text-gray-600 small text-truncate" style="max-width: 100px;">
                        {{review.customerName}} 
                    </span>
                    </div>
                <div class="ml-2" style="font-size: 11px;color:#bdb9b9;"> {{review.timeStamp  | date: 'MMM d, y' }} <span *ngIf="review.isEdited"> .Edited</span></div>
              </div>
              <div> {{review.review}} </div>
            </div>
          </div>
          <div style="border-left: 2px solid #e5e3e3;" class=" d-flex ml-3" *ngIf="review.partnerId">
              <div>
                <div>
                   <span class="d-none d-lg-inline text-gray-600 small text-truncate" style="max-width: 100px;">
                    Response from Owner
                   </span>
                <span style="font-size: 11px;color:#bdb9b9;"> {{review.timeStamp  | date: 'MMM d, y' }} <span *ngIf="review.isEdited"> .Edited</span></span>
                </div>
              <div> {{review.review}} </div>
            </div>
        </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
</div>